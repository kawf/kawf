<VirtualHost *:80>
  ServerName <%= node[:kawf][:server_name] %>
  <% if node[:kawf][:server_aliases] && !node[:kawf][:server_aliases].empty? -%>
  ServerAlias <% node[:kawf][:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
  <% end -%>
  DocumentRoot <%= node[:kawf][:docroot] %>

  <Directory /var/www/kawf/config>
    Require all granted
  </Directory>

  <Directory /var/www/kawf/config/search>
    SetEnv search
  </Directory>

  FileETag none

  <IfModule mod_rewrite.c>
    RewriteEngine On

    # redirect http to https
    RewriteCond %{HTTP:X-Forwarded-Proto} =http
    RewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]

    # send search on transparently
    RewriteRule ^/(search/.*)$			/$1 [L]
    # send pics to index.php
    RewriteRule ^/(pics/.*|favicon.ico)$	/index.php [L]

    # actual forum: disable
    #RewriteRule ^/.*				/index.php [L]

    # send everything else to the real forum
    RedirectMatch (.*)				https://forums.wayot.org/$1
  </IfModule>
</VirtualHost>
